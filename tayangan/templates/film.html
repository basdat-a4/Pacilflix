{% extends 'base.html' %} 

{% block meta %}
{% endblock meta %}

{% block content %}
<body>
    {% include "navbar-user.html" %}
    <div class="container mt-5">
        <h1>HALAMAN FILM</h1>

        <!-- Judul Film -->
        <h2>Judul: {{ dataFilm.1 }}</h2>
        <input type="range" class="form-range" min="0" max="100" id="durasi">
        <!-- Tombol-->
        <div class="mb-3">
            <button type="button" class="btn btn-primary">Tonton</button>
            <button type="button" class="btn btn-primary">Unduh Tayangan</button>
            <button type="button" class="btn btn-primary">Favorit Tayangan</button>
        </div>

        <!-- Informasi Film -->
        <div class="mb-3">
            <p>Total View: NOT YET</p>
            <p>Rating Rata-Rata: {{ avgRating.0 }} / 5.0</p>
            <p>Sinopsis: {{ dataFilm.2 }}</p>
            <p>Durasi Film: {{ dataFilm.3 }} menit</p>
            <p>Tanggal Rilis Film: {{ dataFilm.4 }}</p>
            <p>URL Film: {{ dataFilm.5 }}</p>
            <p>Genre:</p>
            {% for row in genre %}
            <ul>
                <li>{{ row.0 }}</li>
            </ul>
            {% endfor %}
            <p>Asal Negara: {{ dataFilm.6 }}</p>
            <p>Pemain:</p>
            {% for row in pemain %}
            <ul>
                <li>{{ row.0 }}</li>
            </ul>
            {% endfor %}
            <p>Penulis Skenario:</p>
            {% for row in penulis %}
            <ul>
                <li>{{ row.0 }}</li>
            </ul>
            {% endfor %}
            <p>Sutradara: {{ sutradara.0 }}</p>
        </div>

        <!-- Bagian Ulasan -->
        <h2>BAGIAN ULASAN</h2>

        <!-- Input Deskripsi Ulasan -->
        <div class="mb-3">
            <input type="text" class="form-control" placeholder="Input untuk deskripsi ulasan" id="reviewDescriptionInput">
            <input type="number" class="form-control" placeholder="Rating (0-5)" id="reviewRatingInput" min="0" max="5" value="0">
            <button type="button" class="btn btn-primary" id="submitReviewButton">Submit</button>
        </div>

        <!-- Daftar Ulasan -->
        <ul id="reviewList">
        </ul>
    </div>
</body>

<script>
    document.getElementById('submitReviewButton').addEventListener('click', function () {
        var reviewDescription = document.getElementById('reviewDescriptionInput').value;
        var reviewRating = document.getElementById('reviewRatingInput').value;
        var username = "{{ username }}"; // Ambil username dari konteks

        // Kirim data ulasan ke view Django menggunakan Ajax
        fetch("{% url 'tayangan:submit_review' %}?id=" + "{{ id }}" + "&deskripsi=" + reviewDescription + "&rating=" + reviewRating, {
            method: 'POST',
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Error in submitting review');
            }
        })
        .then(data => {
            // Clear input fields after submission
            document.getElementById('reviewDescriptionInput').value = '';
            document.getElementById('reviewRatingInput').value = '0';
        })
        .then(() => {
                // Tampilkan ulasan di halaman
                fetchReviews();
        })
        .catch(error => {
            console.error('Error:', error);
            // Tampilkan pesan error jika terjadi kesalahan
            alert('Error in submitting review');
        });
    });

    // Ketika halaman dimuat, panggil fungsi untuk mendapatkan ulasan
    document.addEventListener('DOMContentLoaded', function () {
        fetchReviews();
    });

    // Fungsi untuk mendapatkan ulasan dari server
    function fetchReviews() {
        fetch("{% url 'tayangan:get_reviews' %}?id=" + "{{ id }}")  // Sesuaikan dengan URL endpoint Anda
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                else {
                    throw new Error('Error in fetching reviews');
                }
            })
            .then(reviews => {
                // Tampilkan ulasan di halaman
                displayReviews(reviews);
            })
            .catch(error => {
                console.error('Error:', error);
                // Tampilkan pesan error jika terjadi kesalahan
                alert('Error in fetching reviews');
            });
    }

    // Fungsi untuk menampilkan ulasan di halaman
    function displayReviews(reviews) {
        var reviewList = document.getElementById('reviewList');
        // Hapus semua ulasan yang ada sebelum menambahkan ulasan baru
        reviewList.innerHTML = '';

        reviews.forEach(review => {
            var newReview = document.createElement('li');
            newReview.textContent = "By: " + review.username + " - " + review.deskripsi + ' - Rating: ' + review.rating + " / 5";
            reviewList.appendChild(newReview);
        });
    }
</script>
{% endblock content %}